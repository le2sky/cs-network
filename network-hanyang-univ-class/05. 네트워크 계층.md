# 네트워크 계층

```
한양대학교 이석복 교수님의 컴퓨터네트워크 강의를 요약한 글임을 미리 밝힙니다. 문제가 될 경우 삭제 조치 하겠습니다.
```

## TOC

---

## 1. Router

> 네트워크 계층의 대표적인 장비는 라우터다. 또한 대표적인 프로토콜로서 IP가 중요하다.

IP가 중요한 이유는 현재 인터넷은 TCP/IP 기반으로, 라우터들이 IP 패킷을 씌운 정보만 이해해서 넘기기 때문이다.

**라우터가 수행하는 두 가지 기능 :**

(1) `forwarding` :들어온 패킷을 포워딩 테이블을 참조해서 올바른 위치로 보내주는 것

- 포워딩 자체는 단순하지만, 이슈가 발생하는 이유는 빠르게 해줘야 하기 때문에 로스가 생김

<p align="center">
    <img src="../resource/network_hanyang_basic_5/router1.png"/>
</p>

- 이때 포워딩 테이블은 destination 주소가 엔트리로 들어가면 너무 커지기 때문에, 엔트리는 주소 range가 들어간다. (아래의 예시 확인)
<p align="center">
    <img src="../resource/network_hanyang_basic_5/router2.png"/>
</p>

- 더 현실적으로 표현하면 아래와 같다.
  - 이때 \* 표시를 통해서 범위를 저장하기 때문에 여러 개에 매칭될 수 있다.
  - 그럼 가장 길게 prefix가 매칭되는 걸 찾아서 그곳으로 포워딩을 하면 된다.

<p align="center">
    <img src="../resource/network_hanyang_basic_5/router2.png"/>
</p>

예를 들자면

- ex 1) DA: 11001000 00010111 00010110 10100001

  - 이 경우에는 빨간색으로 표시된 부분이 0번과 매칭 되기 때문에 0번으로 보내면 된다.

- ex 2) DA: 11001000 00010111 00011000 10101010

  - 이 경우에는 1번, 2번 모두에 매칭된다.

  - 그런데 `longest prefix matching`을 선택해야 하니까, 1번으로 보내면 된다.

> 1번을 안산시 상록구로, 2번을 안산시로 생각한다면, 당연히 1번이 더 정확하다.

---

(2) `routing` : 포워딩 테이블을 채우는 과정이다.

- 인터넷에 존재하는 IP 라우터들은 badnwidth나 delay, loss를 전혀 보장해주지 않는다.
- 그렇기 때문에 전송 계층에서 이를 보장해준다.

## 2. Router architecture

<p align="center">
    <img src="../resource/network_hanyang_basic_5/ra.png"/>
</p>

- 라우터는 위와 같이 input으로 들어온 것을 올바른 output으로 옮겨주는 것이다.

- 포워딩 테이블이 만들어질 때 포워딩 테이블은 각 input 포트에 독립적으로 저장된다.

---

**input port 구조**

<p align="center">
    <img src="../resource/network_hanyang_basic_5/inputP.png"/>
</p>

- 들어오는 것들은 독립적으로 처리가 된다.

- 포워딩 연산(매칭하는 작업)보다 패킷이 들어오는 속도가 더 빠를 경우를 대비하여 queue가 존재한다.

- 이때 queue에 저장할 수 없을 정도로 많은 패킷이 들어오면 loss가 발생하고, 연산 처리 속도보다 들어오는 속도가 빠르면 delay가 발생한다.

- Output port도 동일하게 되어 있다.

## 3. IP

> IP 주소는 머신의 네트워크 인터페이스를 지칭한다.

- 보통은 인터페이스가 하나이기 때문에 IP가 하나라고 생각하는데, 인터페이스가 여러 개 있으면 IP가 여러 개가 된다.

- IP가 여러 개, 즉 인터페이스가 여러 개인 디바이스가 라우터이다.

---

**IP datagram format :**

<p align="center">
    <img src="../resource/network_hanyang_basic_5/ipDgram.png"/>
</p>

- IP 패킷의 최종 형태는 IP 헤더 - TCP 헤더 - 애플리케이션 메시지이다.

- IP 헤더와 TCP 헤더는 각각 20바이트로, 이 부분은 오버헤드가 된다.

- `TTL(time to live)` : 패킷이 무한 루프에 빠지지 않도록 패킷에 수명을 주어 TTL에 기재된 숫자가 0이 되면 패킷을 버리는 것

- `Upper layer` : IP 패킷의 데이터에 담긴 것을 상위 레이어에 올려줄 때, TCP인지 UDP인지 아니면 다른 것인지 구분해서 올바르게 보내줄 수 있도록 하는 것.

```
IP 패킷을 보다 보면 딱 40바이트 크기의 패킷이 있다.

⇒ 우리가 영화 같은 것을 다운로드 할 때 서버에서 데이터가 온다. 이때 우리는 다운로드가 목적이기 때문에 보낼 게 없는데 잘 받고 있다는 TCP feedback을 전송해주어야 한다. 이 TCP ack 용도로 40바이트가 날라간다.
```

---

**IP 주소의 배정 방식 :**

(1) 유효한 IP 주소 32비트를 누가 가지고 있다가 필요한 사용자가 생기면 배정해주는 방식

- `단점`: 사용자가 늘어남에 따라 이용이 힘들어진다.

- 필요할 때 마다 주게 되면 배정은 편하지만, 라우터가 포워딩 할 때 엔트리 개수가 커지기 때문에(모든 주소에 대해서 어느 방향으로 가야 할 지 써야 하기 때문에) 매칭이 오래 걸린다.

> 즉, `scalability` 문제가 생긴다. 이를 해결하기 위해서는 계층화를 해야 한다.

(2) 계층화를 통해 배정해주는 방식

- 계층화를 한다는 건 IP 32비트를 통째로 사용하기 보다는 계층을 나누어서 앞의 몇 비트는 어디 네트워크에 속하는지(네트워크 ID == prefix == subnet ID), 뒤의 몇 비트는 어떤 호스트에 속하는지(호스트 ID)로 나눈다는 것이다.
- 즉, 위에서 앞부분 24비트를 IP로 쓰고, 뒤에 8비트를 호스트로 쓴다.
- 이걸 사람이 보기 쉽게 / 로 표현한다.

<p align="center">
    <img src="../resource/network_hanyang_basic_5/prefix.png"/>
</p>

계층화 장점 :

- 같은 네트워크에 속하는 애들은 네트워크 ID가 같기 때문에 포워딩 테이블이 간단해진다.
- 포워딩 테이블이 간단해지기 때문에 매칭도 빠르다.
- 새로운 호스트가 등장해도 포워딩 테이블에 추가할 필요 없이 배정해주면 된다.

서브넷 마스크 :

- 머신들이 이해하기 어렵다. 그래서 머신들이 이해하기 쉽게 서브넷 마스크를 사용한다.

- address와 END 연산 수행해서 어느 서브넷에 있는지 확인
<p align="center">
    <img src="../resource/network_hanyang_basic_5/subnetmask.png"/>
</p>

네트워크 ID와 호스트 ID :

```
네트워크 ID == 식별자 호스트 ID == 사용할 수 있는 호스트 개수(만약 8비트라면 2^8개 사용 가능)
```

- 만약 호스트 1000개가 필요하면? 즉, IP가 10000개가 필요하다면

  ⇒ preifx는 8로 설정하고, 나머지를 host로 설정한다.

- 이때는 그럼 전 세계에서 네트워크가 2^8개만 존재할 수 있기 때문에 모자라다. 즉, 기관의 수를 감당할 수가 없다는 것.

  ⇒ 그래서 결국 고정시키지 않고 가변적인 방식을 사용한다.

- 또한, 한 호스트에 맞추어서 10000개를 배정했을 경우 다른 호스트는 그 정도까지는 필요하지 않아서 낭비가 발생하기도 한다.

- 네트워크 ID 부분이 포워딩 테이블의 엔트리가 된다.

- Prefix의 개수가 네트워크 전체에 존재하는 기관의 숫자와 동일하다고 생각하자.

- 그럼 기관이 많이 존재하기 때문에 이를 관리하는 기구가 지역별로 존재하고 중앙에서 prefix를 준다.
- 즉, 기관이 기관에 존재하고 있는 인터넷 사업자들이 필요할 때마다 배분해준다.

## 4. Subnets

<p align="center">
    <img src="../resource/network_hanyang_basic_5/subnet.png"/>
</p>

- 같은 네트워크 ID를 가진 인터페이스의 집합

- 즉, 라우터를 거치지 않고 직접적으로 접근할 수 있는 인터페이스의 집합을 의미한다.

- 위처럼 223.1.3의 경우 223.1.3.*에 해당하는 인터페이스에는 라우터를 거치지 않고 접근 가능하지만, 223.1.1.*에 해당하는 인터페이스에는 라우터를 거쳐야만 접근할 수 있다.

- 이때 라우터는 여러 개의 서브넷에 속해있는 중간자이다.

<p align="center">
    <img src="../resource/network_hanyang_basic_5/subnet2.png"/>
</p>

- 이 경우에는 6개의 서브넷이 존재한다.
